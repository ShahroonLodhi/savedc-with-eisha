using System;
using System.Data.SqlClient;
using System.IO;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using SaveDC.ControlPanel.Src.Configurations;
using SaveDC.ControlPanel.Src.Managers;
using SaveDC.ControlPanel.Src.Objects;
using SaveDC.ControlPanel.Src.Utils;

namespace SaveDC.ControlPanel
{
    public partial class AddProgressReport : Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            // page validation
            var oValidator = new Validator();
            oValidator.ValidateRequest(Request);
            oValidator.ValidateUserPageAccess(SaveDCSession.UserAccessLevel,
                                              new[]
                                                  {
                                                      UserAccessLevels.SuperAdmin, UserAccessLevels.Admin,
                                                      UserAccessLevels.Operator
                                                  });
            oValidator = null;

            if (!Page.IsPostBack)
            {
                // load edit user details.
                var oCommon = new Common();
                int nReportId = Utils.fixNullInt(Request.QueryString["ReportId"]);
                if (SaveDCSession.UserAccessLevel == UserAccessLevels.Operator)
                {
                    nReportId = 0;
                }

                string SchoolName = "";
                if (nReportId > 0)
                {
                    int nMonth = 0, nYear = 0;
                    string szNote = "", ImageGUID = "", szAddedBy = "";
                    oCommon.GetProgressReportMonth(nReportId, ref nMonth, ref nYear, ref szNote, ref ImageGUID,
                                                   ref szAddedBy, ref SchoolName);
                    ddMonths.SelectedValue = nMonth.ToString();
                    ddYear.SelectedValue = nYear.ToString();
                    hdnAddEdit.Value = "Edit";

                    string szServerPath = Server.MapPath(SaveDCConstants.ReportUploadPath) + ImageGUID + ".jpg";
                    if (File.Exists(szServerPath))
                    {
                        hdnOldReport.Value = ImageGUID;
                        hdnNewReport.Value = ImageGUID;
                    }
                }
                else
                {
                    ddMonths.SelectedValue = DateTime.Now.Month.ToString();
                    ddYear.SelectedValue = DateTime.Now.Year.ToString();
                }

                int nStudentId = SaveDCSession.StudentId;

                var oStudent = new Student();
                oStudent.StudentId = nStudentId;
                var oStudentManager = new StudentManager(oStudent);
                oStudent = oStudentManager.Load();
                lblStdName.Text = oStudent.FirstName + " " + oStudent.LastName;

                if (oStudent.SchoolId > 0 && string.IsNullOrEmpty(SchoolName))
                {
                    var oSchool = new School();
                    oSchool.SchoolID = oStudent.SchoolId;
                    var oSchoolManager = new SchoolManager(oSchool);
                    oSchool = oSchoolManager.Load();
                    lblSchoolName.Text = oSchool.SchoolName;
                }
                else
                {
                    lblSchoolName.Text = SchoolName;
                }


                SqlDataReader oSqlData = oCommon.LoadStudentProgressReportDetails(nReportId);


                Repeater1.DataSource = oSqlData;
                Repeater1.DataBind();

                hdnEditReportId.Value = nReportId.ToString();
                RenderError(Request.QueryString["status"]);
            }
        }

        private string UploadFileAndReturnName()
        {
            try
            {
                HttpPostedFile hpf = reportUpload.PostedFile;
                if (hpf.ContentLength > 0)
                {
                    if (IsValidImageFile(Path.GetFileName(hpf.FileName)))
                    {
                        string szFileGUID = Guid.NewGuid().ToString();
                        hpf.SaveAs(Server.MapPath(SaveDCConstants.ReportUploadPath) + szFileGUID + ".jpg");
                        return szFileGUID;
                    }
                }
            }
            catch (Exception ex)
            {
            }
            return "";
        }

        protected void btnUpdate_Click(object sender, ImageClickEventArgs e)
        {
            // ajax did not work on the sever so to minimize code changes assigning new file name to hdn control.
            string szFileName = UploadFileAndReturnName();
            if (!string.IsNullOrEmpty(szFileName))
            {
                hdnNewReport.Value = szFileName;
            }

            int nStudentId = SaveDCSession.StudentId;
            // get the edit user id.
            int nEditReportId = 0;
            int.TryParse(hdnEditReportId.Value, out nEditReportId);
            bool bIsEdit = nEditReportId > 0;

            string szNote = txtRemarks.Text;
            string szReportGUID = hdnNewReport.Value;

            var oCommon = new Common();
            int nStatus =
                nEditReportId =
                oCommon.AddStudentProgressReport(nEditReportId, nStudentId, int.Parse(ddMonths.SelectedValue),
                                                 int.Parse(ddYear.SelectedValue), szNote, szReportGUID,
                                                 SaveDCSession.UserId);
            if (nStatus > 0)
            {
                // delete older files.
                try
                {
                    if (!string.IsNullOrEmpty(hdnOldReport.Value) && hdnOldReport.Value != hdnNewReport.Value)
                    {
                        string szServerPath = Server.MapPath(SaveDCConstants.ReportUploadPath) + hdnOldReport.Value +
                                              ".jpg";
                        if (File.Exists(szServerPath))
                        {
                            File.Delete(szServerPath);
                        }
                    }
                }
                catch
                {
                }

                foreach (RepeaterItem reportCategory in Repeater1.Items)
                {
                    int categoryId = int.Parse(((HiddenField) reportCategory.FindControl("hdnReportParticularId")).Value);
                    string szNotes = ((TextBox) reportCategory.FindControl("txtNotes")).Text;
                    int nRemarksId =
                        int.Parse(((RadioButtonList) reportCategory.FindControl("chkRemarks")).SelectedValue);

                    oCommon.AddStudentProgressReportDetail(nEditReportId, categoryId, szNotes, nRemarksId);
                }
            }
            // save student info

            if (nStatus > 0)
            {
                if (bIsEdit)
                    Response.Redirect("ListProgressReports.aspx?status=5031021"); //  
                else
                    Response.Redirect("ListProgressReports.aspx?status=5031011");
            }
            else
            {
                Response.Redirect("AddProgressReport.aspx?status=5031010&ReportId=" + nEditReportId.ToString());
            }
        }

        private void RenderError(string szErrorCode)
        {
            if (string.IsNullOrEmpty(szErrorCode))
            {
                lblError.Text = "";
                return;
            }

            string szErrorDesc = Utils.GetMessageText(szErrorCode);
            if (!szErrorCode.EndsWith("1"))
                lblError.CssClass = "FailureMessage";
            else
                lblError.CssClass = "SuccessMessage";

            lblError.Text = szErrorDesc;
        }

        protected void Repeater1_ItemDataBound(object sender, RepeaterItemEventArgs e)
        {
            try
            {
                if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
                {
                    var radioButtonVoteItem = (RadioButtonList) e.Item.FindControl("chkRemarks");
                    string selectedRemarks = ((HiddenField) e.Item.FindControl("hdnPrevRemarks")).Value;
                    radioButtonVoteItem.SelectedValue = selectedRemarks;
                }
            }
            catch (Exception exception)
            {
            }
        }

        //protected void ProcessUpload1(object sender, AjaxControlToolkit.AsyncFileUploadEventArgs e)
        //{
        //    //if (AsyncFileUpload1.HasFile && IsValidImageFile(AsyncFileUpload1.FileName))
        //    //{
        //    //    string szFileUniqueName = Guid.NewGuid().ToString();
        //    //    string szServerPath = Server.MapPath("../Images/ProgressReports/") + szFileUniqueName + ".jpg";
        //    //    AsyncFileUpload1.SaveAs(szServerPath);

        //    //    string szScript = " top.document.getElementById('browseReport').style.display = 'none'; "  +
        //    // "top.document.getElementById('viewReport' ).style.display  = ''; " +
        //    // " top.document.getElementById('" + hdnNewReport.ClientID + "').value= '" + szFileUniqueName + "'; ";


        //    //    ScriptManager.RegisterClientScriptBlock(PlaceHolder1, PlaceHolder1.GetType(), "a1",
        //    //        "top.document.getElementById('viewlink1').href='../Images/ProgressReports/" + szFileUniqueName + ".jpg';  " + szScript,
        //    //        true);
        //    //}
        //}
        private bool IsValidImageFile(string szFileName)
        {
            szFileName = szFileName.ToLower();
            if (szFileName.EndsWith(".gif"))
                return true;
            if (szFileName.EndsWith(".jpg"))
                return true;
            if (szFileName.EndsWith(".jpeg"))
                return true;
            if (szFileName.EndsWith(".tiff"))
                return true;
            if (szFileName.EndsWith(".png"))
                return true;
            return false;
        }
    }
}