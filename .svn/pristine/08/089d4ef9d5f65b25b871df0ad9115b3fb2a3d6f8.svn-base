using System;
using System.Web.UI;
using SaveDC.ControlPanel.Src.Configurations;
using SaveDC.ControlPanel.Src.Managers;
using SaveDC.ControlPanel.Src.Objects;
using SaveDC.ControlPanel.Src.Utils;

namespace SaveDC.ControlPanel
{
    public partial class AddRemarksForDonor : Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!Page.IsPostBack)
            {
                // page validation
                var oValidator = new Validator();
                oValidator.ValidateRequest(Request);
                oValidator.ValidateUserPageAccess(SaveDCSession.UserAccessLevel,
                                                  new[]
                                                      {
                                                          UserAccessLevels.SuperAdmin, UserAccessLevels.Admin
                                                      });


                int nDonorId = Utils.fixNullInt(Request.QueryString["DonorId"]);

                var user = new User();
                user.UserID = nDonorId;
                var userManager = new UserManager(user);
                user = userManager.Load();

                hdnDonorName.Value = user.UserName;
                hdnDonorId.Value = user.UserID.ToString();
            }
        }

        protected void btnUpdate_Click(object sender, ImageClickEventArgs e)
        {
            #region User Right Validation.

            // only admin and super admin are allowed to execute this part.
            new Validator().CheckUserRightsOnEditDelete(Request);

            #endregion

            int donorId = Utils.fixNullInt(hdnDonorId.Value);

            var user = new User();
            user.UserID = donorId;
            user.RemarksPostedBy = SaveDCSession.UserId;
            var userManager = new UserManager(user);

            if (userManager.AddRemarks(txtMessage.Text))
                Response.Redirect("ListDonors.aspx?status=5011311");
            else
                Response.Redirect("ListDonors.aspx?status=5011310");
        }
    }
}