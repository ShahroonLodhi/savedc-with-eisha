using System;
using System.Net;
using System.Net.Mail;
using SaveDC.ControlPanel.Src.Configurations;
using SaveDC.ControlPanel.Src.Objects;
using SaveDC.ControlPanel.Src.Managers;

namespace SaveDC.ControlPanel.Src.Utils
{
    public class EmailSender
    {
        public static bool SendEmail(Email email)
        {
            try
            {
                var fromAddress = new MailAddress(EmailConfiguration.FromAddress);
                var toAddress = new MailAddress(email.DonorEmail);
                string month = DateTime.Now.ToString("MMM, yyyy");

                string body = string.Format(EmailConfiguration.MailBody, email.FirstName + " " + email.LastName,
                                            email.Amount, month);

                var smtp = new SmtpClient
                               {
                                   Host = EmailConfiguration.SMTPHost,
                                   Port = EmailConfiguration.SMTPPort,
                                   EnableSsl = true,
                                   DeliveryMethod = SmtpDeliveryMethod.Network,
                                   Credentials = new NetworkCredential(fromAddress.Address, EmailConfiguration.FromPwd),
                                   Timeout = 20000
                               };
                using (var message = new MailMessage(fromAddress, toAddress)
                                         {
                                             Subject = EmailConfiguration.MailSubject,
                                             Body = body
                                         })
                {
                    smtp.Send(message);
                }
            }
            catch (Exception e)
            {
                Utils.LogErrorToFile(e);
                return false;
            }
            return true;
        }

        public static bool SendEmailEx(EmailEx email, bool changeBody)
        {
            try
            {
                var fromAddress = new MailAddress(EmailConfiguration.FromAddress);
                var toAddress = new MailAddress(email.DonorEmail);
                
                var smtp = new SmtpClient
                {
                    Host = EmailConfiguration.SMTPHost,
                    Port = EmailConfiguration.SMTPPort,
                    EnableSsl = false,
                    DeliveryMethod = SmtpDeliveryMethod.Network,
                    Credentials = new NetworkCredential("accounts@save-dc.org", "accounts000"),
                    Timeout = 20000
                };
                using (var message = new MailMessage(new MailAddress("accounts@save-dc.org"), toAddress)
                {
                    Subject = email.Subject,
                    Body = (changeBody) ? "Dear " + email.DonorName + ",\r\n" + email.Body + "\r\n\r\nRegards,\r\nSAVE DC Email Service\r\nhttp://save-dc.org" : email.Body
                })
                {
                    if (email.CC != "" && email.CC != null)
                    {
                        var ccAddress = new MailAddress(email.CC);
                        message.CC.Add(ccAddress);
                    }
                    if (email.BCC == true)
                    {
                        var oUser = new User();
                        var oUserManager = new UserManager(oUser);
                        oUser.UserRoleID = 4;
                        User[] users = oUserManager.GetUsers();
                        
                        for (var i = 0; i < users.Length; i++)
                        {
                            if (users[i].EmailAddress != "" && users[i].EmailAddress != null)
                            {
                                var bccAddress = new MailAddress(users[i].EmailAddress);
                                message.Bcc.Add(bccAddress);
                            }
                        }
                    }
                    smtp.Send(message);
                }
            }
            catch (Exception e)
            {
                Utils.LogErrorToFile(e);
                return false;
            }
            return true;
        }
    }
}