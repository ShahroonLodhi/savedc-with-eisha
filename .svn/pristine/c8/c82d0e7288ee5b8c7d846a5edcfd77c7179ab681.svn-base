using System;
using System.Web.UI;
using System.Web.UI.WebControls;
using SaveDC.ControlPanel.Src.Configurations;
using SaveDC.ControlPanel.Src.Managers;
using SaveDC.ControlPanel.Src.Objects;
using SaveDC.ControlPanel.Src.Utils;

namespace SaveDC.ControlPanel
{
    public partial class ListSchools : Page
    {
        #region Delegates

        public delegate void delPopulateData(int nCurrentPage);

        #endregion

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!Page.IsPostBack)
            {
                // page validation
                var oValidator = new Validator();
                oValidator.ValidateRequest(Request);
                oValidator.ValidateUserPageAccess(SaveDCSession.UserAccessLevel,
                                                  new[]
                                                      {
                                                          UserAccessLevels.SuperAdmin, UserAccessLevels.Admin,
                                                          UserAccessLevels.Operator
                                                      });

                // dont allow operator to edit.
                if (SaveDCSession.UserAccessLevel == UserAccessLevels.Operator)
                {
                    btnDelSchool.Visible = false;
                    btnEditSchool.Visible = false;
                    btnSendSms.Visible = false;
                    btnSmsHistory.Visible = false;
                }


                LoadSchools(1);
                RenderError(Request.QueryString["status"]);
            }
            delPopulateData delPopulate = LoadSchools;
            pagerApps.UpdatePageIndex = delPopulate;
        }

        private void LoadSchools(int nCurrentPage)
        {
            string szSrchSchoolName = "";
            if (!string.IsNullOrEmpty(Request.QueryString["SchoolName"]))
            {
                szSrchSchoolName = Request.QueryString["SchoolName"];
                txtSchoolName.Text = szSrchSchoolName;
            }

            var school = new School();
            school.SchoolName = szSrchSchoolName;

            var oSchoolManager = new SchoolManager(school);
            School[] schools = oSchoolManager.GetSchools(nCurrentPage, pagerApps.RecordsPerPage);

            //===============================================================
            pagerApps.TotalRecords = Convert.ToInt32(oSchoolManager.RecordCount);
            //===============================================================

            dgSchools.DataSource = schools;
            dgSchools.DataBind();


            // hide/show grid if no rec found
            if (schools == null || schools.Length <= 0)
            {
                // set the total
                lblTotal.Text = 0.ToString();
                tbDataFound.Visible = false;
                tbNoDataFound.Visible = true;
            }
            else
            {
                // set the total
                lblTotal.Text = schools.Length.ToString();
                tbDataFound.Visible = true;
                tbNoDataFound.Visible = false;
            }
        }

        private void RenderError(string szErrorCode)
        {
            if (string.IsNullOrEmpty(szErrorCode))
            {
                lblError.Text = "";
                return;
            }

            string szErrorDesc = Utils.GetMessageText(szErrorCode);
            if (!szErrorCode.EndsWith("1"))
                lblError.CssClass = "FailureMessage";
            else
                lblError.CssClass = "SuccessMessage";

            lblError.Text = szErrorDesc;
        }

        protected void searchbtn_Click(object sender, ImageClickEventArgs e)
        {
            string szSrchSchoolName = txtSchoolName.Text;
            //if (!string.IsNullOrEmpty(Request.Form["ctl00$ContentPlaceHolder1$txtSchoolName"]))
            //    szSrchSchoolName = Request.Form["ctl00$ContentPlaceHolder1$txtSchoolName"];

            Response.Redirect("ListSchools.aspx?SchoolName=" + szSrchSchoolName);
        }

        protected void dgSchools_Databound(object sender, DataGridItemEventArgs e)
        {
            if (e.Item.ItemType == ListItemType.Item ||
                e.Item.ItemType == ListItemType.AlternatingItem)
            {
                string curSchoolStdCount =
                    Utils.fixNullString(((HiddenField) e.Item.FindControl("hdnSchoolStdCount")).Value);
                if (curSchoolStdCount == "0")
                {
                    e.Item.Style.Add("background-color", "red");
                    e.Item.Style.Add("color", "white");
                }
            }
        }

        protected void btnEditSchool_Click(object sender, EventArgs e)
        {
            #region User Right Validation.

            // only admin and super admin are allowed to execute this part.
            new Validator().CheckUserRightsOnEditDelete(Request);

            #endregion

            string szCurSchoolId = hdnSchoolID.Value;
            Response.Redirect("AddSchool.aspx?SchoolId=" + szCurSchoolId);
        }


        protected void btnDelSchool_Click(object sender, EventArgs e)
        {
            #region User Right Validation.

            // only admin and super admin are allowed to execute this part.
            new Validator().CheckUserRightsOnEditDelete(Request);

            #endregion

            string szCurSchoolId = hdnSchoolID.Value;

            var oSchool = new School();
            oSchool.SchoolID = int.Parse(szCurSchoolId);

            string szStatus = "5021060";
            var oSchoolManager = new SchoolManager(oSchool);
            if (oSchoolManager.Delete())
            {
                szStatus = "5021061";
            }

            Response.Redirect("ListSchools.aspx?status=" + szStatus);
        }

        protected void btnDetails_Click(object sender, EventArgs e)
        {
            string szCurSchoolId = hdnSchoolID.Value;
            Response.Redirect("DetailsSchool.aspx?SchoolId=" + szCurSchoolId);
        }

        protected void btnSendSMS_Click(object sender, EventArgs e)
        {
            #region User Right Validation.

            // only admin and super admin are allowed to execute this part.
            new Validator().CheckUserRightsOnEditDelete(Request);

            #endregion

            string szCurSchoolId = hdnSchoolID.Value;
            Response.Redirect("SendSMSToSchool.aspx?SchoolId=" + szCurSchoolId);
        }

        protected void btnSMSHistory_Click(object sender, EventArgs e)
        {
            #region User Right Validation.

            // only admin and super admin are allowed to execute this part.
            new Validator().CheckUserRightsOnEditDelete(Request);

            #endregion

            string szCurSchoolId = hdnSchoolID.Value;
            Response.Redirect("ListSchoolSMS.aspx?SchoolId=" + szCurSchoolId + "&Type=SCH");
        }
    }
}